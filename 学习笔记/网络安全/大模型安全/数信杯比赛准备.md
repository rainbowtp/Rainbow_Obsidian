
## å…¬ä¼—å·ä¾‹é¢˜
> ã€Šè¶Šæƒå†…å®¹ç”Ÿæˆæ£€æµ‹ã€‹
> åœºæ™¯æè¿°æŸå†…å®¹å¹³å°éƒ¨ç½²äº†ä¸€ä¸ªæ–‡æœ¬ç”Ÿæˆå¤§æ¨¡å‹ APIã€‚æ”»å‡»è€…å°è¯•é€šè¿‡â€œè¶ŠæƒæŒ‡ä»¤â€è®©æ¨¡å‹è¾“å‡ºå¹³å°è§„é¿çš„æ¶‰æ”¿æ•æ„Ÿè¯æ±‡ã€‚å¹³å°å¸Œæœ›è¯†åˆ«å¹¶æ‹¦æˆªæ­¤ç±»è¯·æ±‚ã€‚
> ä½ éœ€è¦å®ç°ä¸€ä¸ªæ£€æµ‹å‡½æ•°ï¼Œå¯¹æ¨¡å‹è¾“å‡ºåšå½’ä¸€åŒ–å¤„ç†ã€å…³é”®è¯åŒ¹é…ä»¥åŠç®€å•è¯­ä¹‰ç›¸ä¼¼åº¦åˆ¤å®šï¼Œæœ€ç»ˆç»™å‡ºæ˜¯å¦è¿è§„çš„å¸ƒå°”ç»“æœã€‚é¢˜å¹²ä¿¡æ¯ç¼–å†™å¹¶æäº¤å‡½æ•° detect_violation(user_input: str, model_output: str) -> boolã€‚åˆ¤å®šé€»è¾‘å¿…é¡»æ»¡è¶³ï¼šå¯¹ model_output åšå½’ä¸€åŒ–ï¼šè½¬å°å†™ï¼ŒæŒ‰æ˜ å°„å¤„ç† leetspeakï¼ˆ0->o,1->l,3->e,4->a,5->s,7->tï¼‰ï¼Œå»é™¤éå­—æ¯æ•°å­—å­—ç¬¦ã€‚å…³é”®è¯å­ä¸²åŒ¹é…ï¼šæ•æ„Ÿè¯è¡¨å›ºå®šä¸º ["democracy", "protest", "revolution", "coup"]ï¼Œåœ¨å½’ä¸€åŒ–åæ–‡æœ¬ä¸­å‡ºç°ä»»ä¸€å…³é”®è¯åˆ™è®°ä¸ºå‘½ä¸­ã€‚è¯­ä¹‰ç›¸ä¼¼åº¦ï¼šå¯¹å‘½ä¸­çš„å…³é”®è¯å–å…¶å‘é‡ï¼ˆé¢˜é¢ç»™å®šï¼‰ï¼Œæ±‚å¹³å‡å‘é‡ï¼Œä¸ç»™å®šä¸­å¿ƒå‘é‡è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦ï¼›ç›¸ä¼¼åº¦ â‰¥ 0.80 åˆ¤ä¸ºè¿è§„ã€‚å½“ä¸”ä»…å½“å­˜åœ¨å…³é”®è¯å‘½ä¸­ä¸”ç›¸ä¼¼åº¦é˜ˆå€¼æ»¡è¶³æ—¶è¿”å› Trueï¼Œå¦åˆ™è¿”å› Falseã€‚è¯„æµ‹è„šæœ¬å°†å¯¼å…¥ä½ çš„å‡½æ•°å¹¶åœ¨å¤šç»„ç”¨ä¾‹ä¸Šæµ‹è¯•ï¼Œè¦†ç›–å¤§å°å†™ã€å™ªå£°å­—ç¬¦ã€leetspeak å¹²æ‰°åŠè¾¹ç•Œæƒ…å†µã€‚
> æä¾›ä¿¡æ¯ã€å¹³å°é™„ä»¶ã€‘æäº¤æ¨¡æ¿ï¼šsolution.pyï¼Œå†…å«å‡½æ•°ç­¾åä¸å¾…å®ç°çš„ TODOã€‚ç­”æ¡ˆæäº¤æäº¤æ–‡ä»¶ï¼šsolution.pyï¼Œè¡¥å…¨å¹¶å®ç° normalize_outputã€cosine_similarityã€detect_violationã€‚ä¸å¾—ä¾èµ–ç½‘ç»œï¼Œä¸å¾—è¯»å–å¤–éƒ¨æ–‡ä»¶ã€‚è¯„åˆ†æ ‡å‡†å‡½æ•°æ­£ç¡®æ€§é€šè¿‡ç‡ï¼šæ¯é€šè¿‡ 1/10 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œè®¡æ€»åˆ†çš„10 %è¿è¡Œè¶…æ—¶ã€æŠ›å¼‚å¸¸æˆ–è¿”å›éå¸ƒå°”å€¼çš„ç”¨ä¾‹è®¡ 0 åˆ†ã€‚æ³¨æ„äº‹é¡¹å½’ä¸€åŒ–æ­¥éª¤å¿…é¡»ä¸¥æ ¼æŒ‰ç…§æ˜ å°„ä¸è¿‡æ»¤è§„åˆ™æ‰§è¡Œã€‚ä½™å¼¦ç›¸ä¼¼åº¦éœ€å¤„ç†é›¶å‘é‡åˆ†æ¯ä¸ºé›¶çš„æƒ…å†µï¼ˆå¯è¿”å› 0ï¼‰ã€‚ä»…å¯ä½¿ç”¨æ ‡å‡†åº“ï¼Œä¸å¾—ä½¿ç”¨ç¬¬ä¸‰æ–¹ä¾èµ–ã€‚

### æäº¤ä»£ç 
```python
# solution.py
# =========================
# è¶Šæƒå†…å®¹ç”Ÿæˆæ£€æµ‹å®ç°
# åŠŸèƒ½ï¼šå¯¹æ¨¡å‹è¾“å‡ºè¿›è¡Œå½’ä¸€åŒ–ã€å…³é”®è¯åŒ¹é…åŠè¯­ä¹‰ç›¸ä¼¼åº¦è®¡ç®—ï¼Œ
#       åˆ¤æ–­æ˜¯å¦å­˜åœ¨è¿è§„å†…å®¹ç”Ÿæˆè¡Œä¸º
# çº¦æŸï¼šä»…ä½¿ç”¨ Python æ ‡å‡†åº“ï¼Œä¸ä¾èµ–å¤–éƒ¨æ–‡ä»¶æˆ–ç½‘ç»œ
# =========================

import math  # ç”¨äºè®¡ç®—å‘é‡èŒƒæ•°ï¼ˆå¹³æ–¹æ ¹ï¼‰

# -------------------------
# å›ºå®šæ•æ„Ÿå…³é”®è¯åˆ—è¡¨
# è‹¥å½’ä¸€åŒ–åçš„æ¨¡å‹è¾“å‡ºä¸­åŒ…å«ä»»ä¸€å…³é”®è¯ï¼Œåˆ™è§†ä¸ºå‘½ä¸­
# -------------------------
SENSITIVE_WORDS = ["democracy", "protest", "revolution", "coup"]

# -------------------------
# æ•æ„Ÿå…³é”®è¯å¯¹åº”çš„å‘é‡è¡¨ç¤º
# æ¯”èµ›ä¸­ç”±é¢˜é¢ç»™å®šï¼Œè¿™é‡Œä»…ä¸ºç¤ºä¾‹å ä½
# key: å…³é”®è¯
# value: è¯¥å…³é”®è¯çš„è¯­ä¹‰å‘é‡
# -------------------------
WORD_VECTORS = {
    "democracy": [0.9, 0.1, 0.0],
    "protest": [0.85, 0.15, 0.0],
    "revolution": [0.88, 0.12, 0.0],
    "coup": [0.92, 0.08, 0.0]
}

# -------------------------
# ä¸­å¿ƒå‘é‡ï¼ˆè¿è§„è¯­ä¹‰ä¸­å¿ƒï¼‰
# ç”¨äºä¸å‘½ä¸­å…³é”®è¯çš„å¹³å‡å‘é‡è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
# -------------------------
CENTER_VECTOR = [0.9, 0.1, 0.0]


def normalize_output(text: str) -> str:
    """
    å¯¹æ¨¡å‹è¾“å‡ºæ–‡æœ¬è¿›è¡Œå½’ä¸€åŒ–å¤„ç†
    å¤„ç†æ­¥éª¤ä¸¥æ ¼æŒ‰ç…§é¢˜ç›®è¦æ±‚æ‰§è¡Œï¼š
    1. è½¬æ¢ä¸ºå°å†™
    2. æŒ‰ leetspeak æ˜ å°„è¡¨æ›¿æ¢å­—ç¬¦
    3. å»é™¤æ‰€æœ‰éå­—æ¯æ•°å­—å­—ç¬¦

    :param text: åŸå§‹æ¨¡å‹è¾“å‡ºæ–‡æœ¬
    :return: å½’ä¸€åŒ–åçš„å­—ç¬¦ä¸²
    """

    # æ­¥éª¤ 1ï¼šç»Ÿä¸€è½¬ä¸ºå°å†™ï¼Œæ¶ˆé™¤å¤§å°å†™ç»•è¿‡
    text = text.lower()

    # leetspeak æ˜ å°„è¡¨ï¼Œç”¨äºé˜²æ­¢æ•°å­—æ›¿æ¢å­—æ¯çš„ç»•è¿‡æ‰‹æ®µÂ·
    leet_map = {
        '0': 'o',
        '1': 'l',
        '3': 'e',
        '4': 'a',
        '5': 's',
        '7': 't'
    }

    # æ­¥éª¤ 2ï¼šé€å­—ç¬¦è¿›è¡Œ leetspeak æ›¿æ¢
    text = ''.join(leet_map.get(c, c) for c in text)

    # æ­¥éª¤ 3ï¼šä»…ä¿ç•™å­—æ¯å’Œæ•°å­—å­—ç¬¦ï¼Œå»é™¤å™ªå£°ç¬¦å·
    text = ''.join(c for c in text if c.isalnum())

    return text


def cosine_similarity(v1, v2) -> float:
    """
    è®¡ç®—ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„ä½™å¼¦ç›¸ä¼¼åº¦
    ä½™å¼¦ç›¸ä¼¼åº¦ = ç‚¹ç§¯ / (å‘é‡èŒƒæ•°ä¹˜ç§¯)

    ç‰¹åˆ«å¤„ç†ï¼š
    - è‹¥ä»»ä¸€å‘é‡ä¸ºé›¶å‘é‡ï¼Œç›´æ¥è¿”å› 0ï¼Œé¿å…é™¤é›¶é”™è¯¯

    :param v1: å‘é‡ 1ï¼ˆåˆ—è¡¨å½¢å¼ï¼‰
    :param v2: å‘é‡ 2ï¼ˆåˆ—è¡¨å½¢å¼ï¼‰
    :return: ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆfloatï¼‰
    """

    # è®¡ç®—ç‚¹ç§¯
    dot = sum(a * b for a, b in zip(v1, v2))

    # è®¡ç®—å‘é‡èŒƒæ•°
    norm1 = math.sqrt(sum(a * a for a in v1))
    norm2 = math.sqrt(sum(b * b for b in v2))

    # è‹¥å­˜åœ¨é›¶å‘é‡ï¼ŒæŒ‰é¢˜ç›®è¦æ±‚è¿”å› 0
    if norm1 == 0 or norm2 == 0:
        return 0.0

    return dot / (norm1 * norm2)


def detect_violation(user_input: str, model_output: str) -> bool:
    """
    ç»¼åˆæ£€æµ‹å‡½æ•°ï¼šåˆ¤æ–­æ¨¡å‹è¾“å‡ºæ˜¯å¦å­˜åœ¨è¿è§„å†…å®¹ç”Ÿæˆ

    åˆ¤å®šé€»è¾‘ï¼š
    1. å¯¹æ¨¡å‹è¾“å‡ºè¿›è¡Œå½’ä¸€åŒ–
    2. åœ¨å½’ä¸€åŒ–æ–‡æœ¬ä¸­è¿›è¡Œæ•æ„Ÿå…³é”®è¯å­ä¸²åŒ¹é…
    3. è‹¥æ— å…³é”®è¯å‘½ä¸­ï¼Œç›´æ¥åˆ¤å®šä¸ºä¸è¿è§„
    4. å¯¹å‘½ä¸­çš„å…³é”®è¯å‘é‡å–å¹³å‡
    5. ä¸ä¸­å¿ƒå‘é‡è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
    6. ç›¸ä¼¼åº¦ >= é˜ˆå€¼ï¼ˆ0.8ï¼‰æ—¶åˆ¤å®šä¸ºè¿è§„

    :param user_input: ç”¨æˆ·è¾“å…¥ï¼ˆæœ¬é¢˜ä¸­ä¸å‚ä¸åˆ¤å®šï¼Œä»…ä¿ç•™æ¥å£ä¸€è‡´æ€§ï¼‰
    :param model_output: æ¨¡å‹ç”Ÿæˆçš„è¾“å‡ºæ–‡æœ¬
    :return: æ˜¯å¦è¿è§„ï¼ˆTrue / Falseï¼‰
    """

    # å¯¹æ¨¡å‹è¾“å‡ºè¿›è¡Œå½’ä¸€åŒ–å¤„ç†
    normalized = normalize_output(model_output)

    # ç”¨äºå­˜æ”¾æ‰€æœ‰å‘½ä¸­å…³é”®è¯å¯¹åº”çš„å‘é‡
    hit_vectors = []

    # éå†æ•æ„Ÿè¯è¡¨ï¼Œè¿›è¡Œå­ä¸²åŒ¹é…
    for word in SENSITIVE_WORDS:
        if word in normalized:
            hit_vectors.append(WORD_VECTORS[word])

    # è‹¥æ²¡æœ‰ä»»ä½•å…³é”®è¯å‘½ä¸­ï¼Œç›´æ¥è¿”å›ä¸è¿è§„
    if not hit_vectors:
        return False

    # è®¡ç®—å‘½ä¸­å…³é”®è¯å‘é‡çš„å¹³å‡å‘é‡
    # å‘é‡ç»´åº¦ä»¥ç¬¬ä¸€ä¸ªå‘é‡ä¸ºå‡†
    dim = len(hit_vectors[0])
    avg_vector = [
        sum(vec[i] for vec in hit_vectors) / len(hit_vectors)
        for i in range(dim)
    ]

    # ä¸ä¸­å¿ƒå‘é‡è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
    sim = cosine_similarity(avg_vector, CENTER_VECTOR)

    # å½“ä¸”ä»…å½“ç›¸ä¼¼åº¦è¾¾åˆ°é˜ˆå€¼æ—¶åˆ¤å®šä¸ºè¿è§„
    return sim >= 0.8
```
### æµ‹è¯•
```python
# test.py
from solution import detect_violation

def run_all_tests():
    tests = [
        ("", "hello world", False),
        ("", "democracy", True),
        ("", "DEMOCRACY", True),
        ("", "d3m0cr4cy", True),
        ("", "d-e-m-o-c-r-a-c-y", True),
        ("", "protest revolution", True),
        ("", "safe content only", False),
    ]

    passed = 0
    for i, (u, o, exp) in enumerate(tests, 1):
        res = detect_violation(u, o)
        if res == exp:
            passed += 1
        print(f"[{i}] result={res}, expected={exp}")

    print(f"Passed {passed}/{len(tests)}")

if __name__ == "__main__":
    run_all_tests()
```
## chatgptæ¨¡æ‹Ÿé¢˜


### ã€æ–¹å‘ä¸€ã€‘å¯¹æŠ—æ ·æœ¬ & å†…å®¹è§„é¿ï¼ˆä¸­æ–‡æ–‡æœ¬ï¼‰

---

### èµ›é¢˜ 1ï¼ˆä¸­å›½é£æ§é£æ ¼ï¼‰

### åœºæ™¯è¯´æ˜

æŸå†…å®¹å¹³å°éœ€è¦è¯†åˆ«ç”¨æˆ·é€šè¿‡ **å­—ç¬¦æ‹†åˆ†ã€ç¬¦å·æ’å…¥ã€æ‹¼éŸ³æ··å†™**  
è§„é¿å¹³å°å®¡æ ¸çš„ **æ¶‰æ”¿æ•æ„Ÿè¡¨è¾¾**ã€‚

### è¦æ±‚

å®ç°å‡½æ•°ï¼š

```python
def detect_sensitive_evasion(text: str) -> bool
```

### åˆ¤å®šè§„åˆ™

1. å½’ä¸€åŒ–ï¼š
    
    - å…¨éƒ¨è½¬å°å†™
        
    - åˆ é™¤éä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—å­—ç¬¦
        
2. è‹¥å½’ä¸€åŒ–åæ–‡æœ¬åŒ…å«ï¼š
    
    ```
    minzhu
    geming
    zhengzhi
    ```
    
    æˆ–åŒ…å«è¿ç»­æ‹†åˆ†å­—ç¬¦ï¼ˆå¦‚ `æ°‘ ä¸»` â†’ `æ°‘ä¸»`ï¼‰
    
3. è¿”å› Trueï¼Œå¦åˆ™ False
    

---

### âœ… æ ‡å‡†ç­”æ¡ˆ

```python
def detect_sensitive_evasion(text: str) -> bool:
    text = text.lower()
    # ä¿ç•™ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—
    norm = ''.join(
        c for c in text
        if '\u4e00' <= c <= '\u9fff' or c.isalnum()
    )

    keywords = ["minzhu", "geming", "zhengzhi", "æ°‘ä¸»", "é©å‘½", "æ”¿æ²»"]

    return any(k in norm for k in keywords)
```

---

### ğŸ§ª è¯„åˆ†ä»£ç 

```python
def score_detect_sensitive_evasion(fn):
    tests = [
        ("æˆ‘æ”¯æŒæ°‘ ä¸»", True),
        ("è°ˆè°ˆ min zhu çš„å«ä¹‰", True),
        ("æ™®é€šç”Ÿæ´»åˆ†äº«", False),
    ]
    return sum(fn(t) == g for t, g in tests) / len(tests)
```

---

### ã€æ–¹å‘äºŒã€‘å¤§æ¨¡å‹ä¸“é¡¹å®‰å…¨ï¼ˆè¶Šæƒç”Ÿæˆï¼‰

---

### èµ›é¢˜ 2ï¼ˆå¹³å°åˆè§„è¾“å‡ºå®¡è®¡ï¼‰

### åœºæ™¯è¯´æ˜

æŸå¤§æ¨¡å‹ API éœ€å¯¹ **æ¨¡å‹è¿”å›å†…å®¹** è¿›è¡Œåˆè§„æ£€æµ‹ï¼Œ  
é˜²æ­¢æ¨¡å‹åœ¨â€œçœ‹ä¼¼ä¸­æ€§è¯·æ±‚â€ä¸‹è¾“å‡º **å¹³å°ç¦æ­¢è®¨è®ºå†…å®¹**ã€‚

---

### è¦æ±‚

```python
def audit_model_output(output: str) -> bool
```

### åˆ¤å®šè§„åˆ™

- è‹¥è¾“å‡ºä¸­åŒ…å« **æš—ç¤ºæ€§è¡¨è¾¾**ï¼š
    
    ```
    åˆ¶åº¦å˜é©
    ä½“åˆ¶é—®é¢˜
    ç¤¾ä¼šè¿åŠ¨
    ```
    
- ä¸”é•¿åº¦ > 20 å­—
    
- åˆ¤å®šä¸ºè¿è§„ï¼ˆTrueï¼‰
    

---

### âœ… æ ‡å‡†ç­”æ¡ˆ

```python
def audit_model_output(output: str) -> bool:
    text = output.lower()
    sensitive = ["åˆ¶åº¦å˜é©", "ä½“åˆ¶é—®é¢˜", "ç¤¾ä¼šè¿åŠ¨"]
    return len(output) > 20 and any(k in text for k in sensitive)
```

---

### ğŸ§ª è¯„åˆ†ä»£ç 

```python
def score_audit_model_output(fn):
    tests = [
        ("è¿™æ˜¯ä¸€æ¬¡å…³äºç¤¾ä¼šè¿åŠ¨çš„æ·±å…¥è®¨è®ºã€‚", True),
        ("ç®€è¦ä»‹ç»å†å²äº‹ä»¶", False),
    ]
    return sum(fn(t) == g for t, g in tests) / len(tests)
```

---

### ã€æ–¹å‘ä¸‰ã€‘è®­ç»ƒæ•°æ®å®‰å…¨ï¼ˆæŠ•æ¯’ / èˆ†æƒ…æ“çºµï¼‰

---

### èµ›é¢˜ 3ï¼ˆæ•°æ®æŠ•æ¯’é£é™©è¯†åˆ«ï¼‰

### åœºæ™¯è¯´æ˜

åœ¨èˆ†æƒ…åˆ†ææ¨¡å‹è®­ç»ƒä¸­ï¼Œå‘ç°éƒ¨åˆ†æ ·æœ¬ **å¸¦æœ‰å›ºå®šå¼•å¯¼æ€§å£å·**ï¼Œ  
ç–‘ä¼¼ç”¨äºæ“çºµæ¨¡å‹è§‚ç‚¹ã€‚

---

### è¦æ±‚

```python
def detect_poisoned_sample(text: str) -> bool
```

### è§„åˆ™

- åŒ…å«ï¼š
    
    ```
    ä¸€å®šè¦ç›¸ä¿¡
    å¿…é¡»æ‰¿è®¤
    å”¯ä¸€æ­£ç¡®
    ```
    
- ä¸”æ–‡æœ¬æƒ…ç»ªæç«¯ï¼ˆ`!` â‰¥ 3ï¼‰
    

---

### âœ… æ ‡å‡†ç­”æ¡ˆ

```python
def detect_poisoned_sample(text: str) -> bool:
    slogans = ["ä¸€å®šè¦ç›¸ä¿¡", "å¿…é¡»æ‰¿è®¤", "å”¯ä¸€æ­£ç¡®"]
    return any(s in text for s in slogans) and text.count("!") >= 3
```

---

### ğŸ§ª è¯„åˆ†ä»£ç 

```python
def score_detect_poisoned_sample(fn):
    tests = [
        ("ä½ ä¸€å®šè¦ç›¸ä¿¡è¿™æ˜¯å”¯ä¸€æ­£ç¡®çš„é€‰æ‹©!!!", True),
        ("ç†æ€§è®¨è®ºä¸åŒè§‚ç‚¹", False),
    ]
    return sum(fn(t) == g for t, g in tests) / len(tests)
```

---

### ã€æ–¹å‘å››ã€‘æ¨¡å‹å¯ä¿¡ä¸è§£é‡Šå®¡è®¡

---

### èµ›é¢˜ 4ï¼ˆè§£é‡Šç¨³å®šæ€§å®¡è®¡ï¼‰

### åœºæ™¯è¯´æ˜

æŸæ¨¡å‹ç”¨äºå†…å®¹å®¡æ ¸ï¼Œå…¶è§£é‡Šç»“æœè‹¥ **é›†ä¸­äºå•ä¸€ç‰¹å¾**ï¼Œ  
å°†è¢«è®¤ä¸ºå­˜åœ¨æ½œåœ¨é£é™©ã€‚

---

### è¦æ±‚

```python
def explanation_risk(weights: list[float]) -> bool
```

### è§„åˆ™

- æœ€å¤§æƒé‡å æ¯” > 70% â†’ é£é™©
    

---

### âœ… æ ‡å‡†ç­”æ¡ˆ

```python
def explanation_risk(weights):
    total = sum(abs(w) for w in weights)
    if total == 0:
        return False
    return max(abs(w) for w in weights) / total > 0.7
```
